<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Information</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 10px;
        background-color: #f0f2f5;
        align-items: center;
        text-align: center;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      h1 {
        color: #1877f2;
        margin-bottom: 20px;
      }
      #status {
        font-weight: bold;
        margin-bottom: 10px;
        color: #606770;
      }
      #fingerprintData {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
      }
      .plus-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #1877f2;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        text-align: center;
        line-height: 60px;
        font-size: 30px;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s;
      }
      .plus-button:hover {
        background-color: #166fe5;
      }
      nav {
        margin-bottom: 10px;
      }
      nav a {
        color: #1877f2;
        text-decoration: none;
        font-weight: bold;
      }
      nav a:hover {
        text-decoration: underline;
      }
      /* Add these styles to your existing styles */
      .user-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        margin-top: 5px;
        justify-content: center;
      }
      .user-card {
        flex: 0 0 auto;
        width: 120px;
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 10px;
        text-align: center;
        transition: transform 0.3s ease;
      }
      .user-card:hover {
        transform: translateY(-5px);
      }
      .user-card img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 5px;
      }
      .user-card h3 {
        margin: 5px 0;
        font-size: 24px;
        color: #1877f2;
      }
      .user-card p {
        margin: 5px 0;
        font-size: 24px;
        color: #606770;
      }
      #timer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 14px;
        color: #606770;
      }
      #timer .time {
        flex: 1;
      }
      #timer .duration {
        font-size: 24px;
        font-weight: bold;
        color: #1877f2;
        margin: 0 5px;
      }
      #timer .utc {
        text-align: left;
        font-size: 24px;
      }
      #timer .local {
        text-align: right;
        font-size: 24px;
      }
      #stopButton {
        display: none;
        margin: 20px auto;
        padding: 12px 24px;
        font-size: 18px;
        font-weight: bold;
        color: #ffffff;
        background-color: #dc3545;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      #stopButton:hover {
        background-color: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      }
      #stopButton:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .remove-button {
        position: absolute;
        top: 2px;
        right: 2px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .remove-button:hover {
        background-color: #c82333;
      }
      .user-card .remove-button {
        display: block; /* Initially visible */
      }
      .session-started .user-card .remove-button {
        display: none; /* Hidden when session starts */
      }
      /* Add smooth scrolling for the container */
      #fingerprintData {
        overflow-x: auto;
        scroll-behavior: smooth;
      }
      /* Hide scrollbar for Chrome, Safari and Opera */
      #fingerprintData::-webkit-scrollbar {
        display: none;
      }
      /* Hide scrollbar for IE, Edge and Firefox */
      #fingerprintData {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      /* Fancy start button */
      #startButton {
        display: block;
        margin: 20px auto;
        padding: 12px 24px;
        font-size: 24px;
        font-weight: bold;
        color: #ffffff;
        background-color: #1877f2;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      #startButton:hover {
        background-color: #166fe5;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      }
      #startButton:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Session Information</h1>
      <nav style="text-align: left">
        <a
          style="
            border: 1px solid rgb(0, 119, 255);
            border-radius: 10px;
            padding: 5px;
            text-decoration: none;
          "
          href="./atco_check_page.html"
          onclick="localStorage.clear()"
          >BACK
        </a>
      </nav>
      <div id="status" style="display: none">Waiting for user data...</div>
      <div id="fingerprintData"></div>
      <button id="startButton" style="display: none">Start Session</button>
      <button id="stopButton" style="display: none">Stop Session</button>
    </div>

    <script>
      const statusElement = document.getElementById("status");
      const dataElement = document.getElementById("fingerprintData");
      const container = document.querySelector(".container");

      // Replace with your actual server address and port
      const eventSource = new EventSource(
        "http://localhost:5000/api/stream-readings"
      );

      let sessionData = [];
      let sessionStartTime = null;
      let sessionId = null;
      let sessionComplete = false;
      let sessionStarted = false;

      const minParticipants = 2;
      const maxParticipants = 4;

      // Load session data from local storage on page load
      function loadSessionData() {
        const storedData = localStorage.getItem("sessionData");
        if (storedData) {
          sessionData = JSON.parse(storedData);
          updateDisplay();
          if (sessionData.length >= minParticipants) {
            document.getElementById("startButton").style.display = "block";
          }
        }
      }

      // Save session data to local storage
      function saveSessionData() {
        localStorage.setItem("sessionData", JSON.stringify(sessionData));
      }

      loadSessionData();

      eventSource.onopen = function () {
        statusElement.textContent =
          "Connected to server. Waiting for user data...";
      };

      eventSource.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log("Received fingerprint data:", data);

        if (sessionComplete) {
          statusElement.textContent =
            "Session already complete. No more check-ins allowed.";
          return;
        }

        if (sessionData.length >= maxParticipants) {
          statusElement.textContent = "Maximum number of participants reached.";
          return;
        }

        const userType = data.user_type;

        // Check if the user is allowed to check in
        if (!["Examiner", "LCE", "Trainer", "Trainee"].includes(userType)) {
          statusElement.textContent =
            "Error: Only Examiner, LCE, Trainer, or Trainee can join sessions.";
          return;
        }

        if (userType === "Trainee" && sessionData.length === 0) {
          statusElement.textContent =
            "Error: Trainee cannot be the first to join.";
          return;
        }

        // Check if user already exists in sessionData
        const existingUserIndex = sessionData.findIndex(
          (user) => user.id === data.id
        );
        if (existingUserIndex !== -1) {
          // Update existing user data
          sessionData[existingUserIndex] = data;
          updateUserCard(data, existingUserIndex);
        } else {
          // Add new user to sessionData
          sessionData.push(data);
          addUserCard(data, sessionData.length - 1);
        }

        saveSessionData();

        if (sessionData.length >= minParticipants) {
          document.getElementById("startButton").style.display = "block";
        }

        statusElement.textContent = `${userType} checked in. ${sessionData.length} participant(s) joined.`;

        if (sessionData.length === maxParticipants) {
          eventSource.close();
          statusElement.textContent += " Maximum participants reached.";
        }
      };

      function updateDisplay() {
        dataElement.innerHTML = "";
        sessionData.forEach((user, index) => {
          addUserCard(user, index);
        });
      }

      function addUserCard(user, index) {
        const imageUrl = `http://127.0.0.1:8000/media/${user.image}`;
        const userCard = document.createElement("div");
        userCard.className = "user-card";
        userCard.innerHTML = `
          <button class="remove-button" onclick="removeUser(${index})">×</button>
          <img src="${imageUrl}" alt="${user.username}'s profile picture">
          <h3>${user.user_type}</h3>
          <p>${user.username}</p>
        `;
        dataElement.appendChild(userCard);
      }

      function updateUserCard(user, index) {
        const userCard = dataElement.children[index];
        if (userCard) {
          const imageUrl = `http://127.0.0.1:8000/media/${user.image}`;
          userCard.innerHTML = `
            <button class="remove-button" onclick="removeUser(${index})">×</button>
            <img src="${imageUrl}" alt="${user.username}'s profile picture">
            <h3>${user.user_type}</h3>
            <p>${user.username}</p>
          `;
        }
      }

      function removeUser(index) {
        if (sessionStarted) {
          alert("Cannot remove users after session has started.");
          return;
        }

        const removedUser = sessionData[index];
        sessionData.splice(index, 1);
        saveSessionData();
        updateDisplay();

        statusElement.textContent = `${removedUser.user_type} removed from session.`;

        if (sessionData.length < minParticipants) {
          document.getElementById("startButton").style.display = "none";
        }
      }

      const startButton = document.getElementById("startButton");
      startButton.addEventListener("click", startSession);

      function startSession() {
        sessionStarted = true;
        sessionComplete = true;
        eventSource.close();
        sessionStartTime = new Date();
        startTimer();
        checkIn();
        startButton.style.display = "none";
        stopButton.style.display = "block";
        updateDisplay();
        statusElement.textContent = "Session started.";
        document.querySelector(".container").classList.add("session-started");
      }

      async function checkIn() {
        const userIds = sessionData.map((user) => user.id);
        try {
          const response = await fetch(
            "http://localhost:8000/session/check-in/",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ users: userIds }),
            }
          );

          if (!response.ok) {
            throw new Error("Check-in failed");
          }

          const data = await response.json();
          sessionId = data.id;
          console.log("Check-in successful. Session ID:", sessionId);
          statusElement.textContent += " Check-in successful.";
        } catch (error) {
          console.error("Check-in error:", error);
          statusElement.textContent += " Check-in failed.";
        }
      }

      async function checkOut() {
        if (!sessionId) {
          console.error("No session ID available for check-out");
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:8000/session/check-out/",
            {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ id: sessionId }),
            }
          );

          if (!response.ok) {
            throw new Error("Check-out failed");
          }

          console.log("Check-out successful");
          localStorage.clear();
          statusElement.textContent = "Session ended. Check-out successful.";
          sessionId = null; // Reset session ID after successful check-out
        } catch (error) {
          console.error("Check-out error:", error);
          statusElement.textContent = "Check-out failed.";
        }
      }

      // Modify the existing navigation link to trigger check-out
      document
        .querySelector("nav a")
        .addEventListener("click", async function (e) {
          e.preventDefault();
          if (sessionId) {
            await stopSession();
          }
          // Navigate to index.html after check-out (or immediately if no active session)
          window.location.href = "atco_check_page.html";
        });

      const stopButton = document.getElementById("stopButton");
      stopButton.addEventListener("click", stopSession);

      async function stopSession() {
        if (sessionId) {
          await checkOut();
          clearInterval(timerInterval);
          stopButton.style.display = "none";
          statusElement.textContent = "Session ended. Check-out successful.";
          document
            .querySelector(".container")
            .classList.remove("session-started");
          // Clear session data from local storage
          localStorage.removeItem("sessionData");
          sessionData = [];
          updateDisplay();
        } else {
          statusElement.textContent = "No active session to stop.";
        }
      }

      let timerInterval;

      function startTimer() {
        const timerElement = document.createElement("div");
        timerElement.id = "timer";
        container.appendChild(timerElement);

        function updateTimer() {
          const now = new Date();
          const diff = now - sessionStartTime;
          const hours = Math.floor(diff / 3600000);
          const minutes = Math.floor((diff % 3600000) / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          const localString = now.toLocaleString();
          const utcString = now.toUTCString();

          timerElement.innerHTML = `
            <div class="time utc">UTC: ${utcString}</div>
            <div class="duration">${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}</div>
            <div class="time local">Local: ${localString}</div>
          `;
        }

        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
      }

      eventSource.onerror = function (error) {
        console.error("EventSource failed:", error);
        statusElement.textContent =
          "Connection error. Please refresh the page.";
        eventSource.close();
      };
    </script>
  </body>
</html>
